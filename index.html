<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHHS Daily Factoring Review (No-CDN, Answer Checker)</title>
  <meta name="description" content="Generates 4 factoring problems of different types each day with solutions — no MathJax required. Includes student answer inputs, checker, and optional submission to a Google Sheet via Apps Script." />
  <style>
    :root{
      --bg:#0b1020; --card:#111833; --ink:#e9edf7; --muted:#b7c0d9; --accent:#6aa6ff; --ok:#38c172; --warn:#f9ac3d; --err:#ef6666;
      --border:#22305e; --input-bg:#f6f8ff; --input-text:#0c1230; --input-bd:#9bb3e3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background: radial-gradient(1200px 900px at 10% 0%, #15224d 0%, var(--bg) 60%); color:var(--ink)}
    header{padding:24px 20px 10px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{margin:0; font-size:clamp(1.2rem,2.2vw + .6rem,2rem); letter-spacing:.3px}
    main{max-width:1100px; margin:0 auto; padding:0 16px 48px}
    .panel{background:linear-gradient(180deg,#121a37,#0e1530); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .controls{display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:12px; align-items:end}
    .controls .col{display:flex; flex-direction:column; gap:6px}
    label{font-size:.8rem; color:var(--muted)}
    input[type="date"], input[type="text"], input.answer{height:40px; border:1px solid var(--input-bd); border-radius:10px; background:var(--input-bg); color:var(--input-text); padding:0 12px}
    input.answer::placeholder{color:#6b75a1}
    input:focus{outline:none; box-shadow:0 0 0 3px rgba(106,166,255,.35)}
    button{height:40px; padding:0 14px; border-radius:10px; border:1px solid var(--border); background:#13204d; color:var(--ink); font-weight:600; cursor:pointer}
    button:hover{background:#192a63}
    .btn-primary{background:linear-gradient(180deg,#2b56cc,#2348ac); border-color:#2b56cc}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:16px; margin-top:16px}
    .card{background:linear-gradient(180deg,#121a37,#0e1530); border:1px solid var(--border); border-radius:14px; padding:16px}
    .card h3{margin:2px 0 12px; font-size:1rem; color:#cdd7ff; letter-spacing:.3px}
    .problem{font-size:1.15rem}
    .meta{font-size:.9rem; color:var(--muted)}
    details{margin-top:8px}
    summary{cursor:pointer; color:var(--accent); font-weight:600}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .footnote{color:var(--muted); font-size:.8rem}
    @media (max-width:860px){.controls{grid-template-columns: repeat(2, minmax(0,1fr))} .grid{grid-template-columns:1fr}}
    .status{font-weight:700}
    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>PHHS Daily Factoring Review</h1>
      <div class="footnote">No MathJax • Deterministic by date • Answer checker • Optional submit to Google Sheet</div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="controls">
        <div class="col">
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div class="col">
          <label for="sid">Student Number</label>
          <input id="sid" type="text" placeholder="e.g., 123456" />
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <label class="row" style="gap:8px; font-size:.9rem"><input type="checkbox" id="hashId"> Hash ID before submit</label>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="regen" class="btn-primary">Generate Set</button>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="reveal">Reveal All Solutions</button>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="printBtn">Print / Save PDF</button>
        </div>
      </div>

      <div class="grid" id="problems"></div>
      <div class="row" style="margin-top:12px">
        <button id="checkBtn" class="btn-primary">Check Answers</button>
        <button id="submitBtn" disabled>Submit Results</button>
        <span id="score" class="status"></span>
      </div>
      <div class="footnote" style="margin-top:8px">Same date ⇒ same set. URL can include <code>?d=YYYY-MM-DD</code> to lock a given day.</div>
    </section>
  </main>

  <script>
    // ======= CONFIG: paste your Apps Script web app URL here to enable submissions =======
    const SCRIPT_URL = ""; // e.g., https://script.google.com/macros/s/AKfycb.../exec

    // ======= Seeded RNG (xmur3 + mulberry32) =======
    function xmur3(str) { let h = 1779033703 ^ str.length; for (let i=0;i<str.length;i++){ h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = (h << 13) | (h >>> 19);} return function(){ h = Math.imul(h ^ (h >>> 16), 2246822507); h = Math.imul(h ^ (h >>> 13), 3266489909); return (h ^= h >>> 16) >>> 0; }; }
    function mulberry32(a) { return function(){ let t = (a += 0x6d2b79f5); t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; }; }
    function seededRand(seedStr){ const seed = xmur3(seedStr)(); return mulberry32(seed); }

    // ======= Utilities =======
    function randint(rand, min, max){ return Math.floor(rand()*(max-min+1))+min; }
    function coin(rand){ return rand()<0.5; }
    function shuffle(rand, arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    // HTML-rendered polynomial like ax^2 + bx + c (no MathJax)
    function polyToHTML(a,b,c){
      const parts=[];
      function addTerm(coef, pow){
        if(coef===0) return;
        const sign = coef<0 ? '-' : (parts.length? '+' : '');
        const abs = Math.abs(coef);
        if(pow===0){ parts.push(`${sign} ${abs}`.trim()); return; }
        const coefStr = (abs===1? '' : abs);
        const xStr = pow===1 ? 'x' : `x<sup>${pow}</sup>`;
        parts.push(`${sign} ${coefStr}${xStr}`.trim());
      }
      addTerm(a,2); addTerm(b,1); addTerm(c,0);
      return parts.join(' ').replace(/\+ -/g,'- ');
    }

    // ======= GCD helpers =======
    function igcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ const t=b; b=a%b; a=t; } return a||0; }
    function polyGcdCoef([c0,c1,c2]){ const arr=[Math.abs(c0),Math.abs(c1),Math.abs(c2)].filter(v=>v!==0); if(arr.length===0) return 0; return arr.reduce((g,v)=>igcd(g,v)); }
    function polyGcdVarPow([c0,c1,c2]){ if(c0!==0) return 0; if(c1!==0) return 1; if(c2!==0) return 2; return 0; }

    // ======= Problem Generators (hidden types to students) =======
    function genGCF(rand){
      const g = randint(rand,2,9); // numeric GCF
      const pow = coin(rand) ? 1 : 0; // avoid pow=2 to prevent monomial only
      let A=randint(rand,1,6), B=randint(rand,1,8), C=randint(rand,1,9);
      if(coin(rand)) B*=-1; if(coin(rand)) C*=-1;
      const poly = [ g*A, (pow<=1? g*B : 0), (pow===0? g*C : 0) ];
      // ensure at least two non-zero terms
      if((poly[0]===0)+(poly[1]===0)+(poly[2]===0) > 1) return genGCF(rand);
      const factorStr = g + (pow>0? `x${pow===1?'':`^${pow}`}` : '');
      const sample = `${factorStr}(${polyToHTML(poly[2]/(pow?1:1), poly[1]/g, poly[0]/g)})`;
      return makeProblem(poly, sample);
    }

    function genDiffSquares(rand){
      const a = randint(rand,2,12), b = randint(rand,2,12);
      const A=a*a, C=-(b*b);
      const poly = [C, 0, A];
      const sample = `(${a}x - ${b})(${a}x + ${b})`;
      return makeProblem(poly, sample);
    }

    function genTrinomialA1(rand){
      const m = randint(rand,1,12) * (coin(rand)?1:-1);
      const n = randint(rand,1,12) * (coin(rand)?1:-1);
      const b = m + n; const c = m * n;
      const poly = [c, b, 1];
      const sample = `(x ${m>=0?'+':''}${m})(x ${n>=0?'+':''}${n})`;
      return makeProblem(poly, sample);
    }

    function genTrinomialAGt1(rand){
      const p = randint(rand,2,6), q = randint(rand,2,6);
      const r = randint(rand,1,10) * (coin(rand)?1:-1);
      const s = randint(rand,1,10) * (coin(rand)?1:-1);
      const a = p*q, b = p*s + q*r, c = r*s;
      const poly = [c,b,a];
      const sample = `(${p}x ${r>=0?'+':''}${r})(${q}x ${s>=0?'+':''}${s})`;
      return makeProblem(poly, sample);
    }

    function makeProblem(coeffs, sample){
      const gCoef = polyGcdCoef(coeffs);
      const gPow  = polyGcdVarPow(coeffs);
      return { coeffs, sample, gCoef, gPow };
    }

    // ======= Deterministic set =======
    function chicagoISO(d=new Date()){
      const fmt = new Intl.DateTimeFormat('en-CA', { timeZone:'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' });
      const parts = fmt.formatToParts(d); const y=parts.find(p=>p.type==='year').value; const m=parts.find(p=>p.type==='month').value; const da=parts.find(p=>p.type==='day').value; return `${y}-${m}-${da}`;
    }
    function readParams(){ const sp = new URLSearchParams(location.search); const d=sp.get('d'); if(d) dateEl.value = d; else dateEl.value = chicagoISO(); }

    // ======= Polynomial helpers for checking =======
    function polyAdd(a,b){ return [a[0]+b[0], a[1]+b[1], a[2]+b[2]]; }
    function polyMul(a,b){ return [ a[0]*b[0], a[0]*b[1]+a[1]*b[0], a[0]*b[2]+a[1]*b[1]+a[2]*b[0] ]; }
    function polyEqual(s, t){ return s[0]===t[0] && s[1]===t[1] && s[2]===t[2]; }

    // Parse expression like (2x-3)(x+4) or -2(x+1)(x-5)
    function expandExpression(expr){
      if(!expr) return null;
      let s = expr.replace(/\s+/g,'');
      s = s.replace(/([0-9x])\(/g, '$1*(').replace(/\)\(/g, ')*(').replace(/\)([0-9x])/g, ')*$1');
      const factorStrs = splitTopLevel(s,'*');
      if(factorStrs.length===0) return null;
      const factorPolys=[];
      let poly = [1,0,0];
      for(const f of factorStrs){ const pf = parseFactor(f); if(!pf) return null; factorPolys.push(pf); poly = polyMul(poly, pf); }
      return { poly, factorPolys };
    }
    function splitTopLevel(s, sep){ const out=[]; let depth=0; let start=0; for(let i=0;i<s.length;i++){ const c=s[i]; if(c==='(') depth++; else if(c===')') depth--; else if(c===sep && depth===0){ out.push(s.slice(start,i)); start=i+1; } } out.push(s.slice(start)); return out.filter(Boolean); }
    function parseFactor(f){ if(f[0]==='(' && f[f.length-1]===')') return parseSum(f.slice(1,-1)); return parseSum(f); }
    function parseSum(s){ const terms = s.match(/[+-]?[^+-]+/g); if(!terms) return null; let poly=[0,0,0]; for(const t of terms){ const pt = parseTerm(t); if(!pt) return null; poly = polyAdd(poly, pt); } return poly; }
    function parseTerm(t){ if(!t) return null; let coef=0, pow=0; if(t.includes('x')){ const [left, ...right] = t.split('x'); const before = left; if(before===''||before==='+') coef=1; else if(before==='-') coef=-1; else coef=parseFloat(before); pow=1; if(right.length>0){ const rest = right.join('x'); if(rest.startsWith('^')){ const p = parseInt(rest.slice(1),10); pow = isNaN(p)?1:p; } } } else { coef=parseFloat(t); pow=0; } if(isNaN(coef)) return null; if(pow<0 || pow>2) return null; const arr=[0,0,0]; arr[pow]=coef; return arr; }

    // ======= Rendering & Checking =======
    const problemsEl = document.getElementById('problems');
    const dateEl = document.getElementById('date');
    const sidEl = document.getElementById('sid');
    const hashIdEl = document.getElementById('hashId');
    const btnRegen = document.getElementById('regen');
    const btnReveal = document.getElementById('reveal');
    const btnCheck = document.getElementById('checkBtn');
    const btnSubmit = document.getElementById('submitBtn');
    const scoreEl = document.getElementById('score');

    function currentSeed(){ return dateEl.value || chicagoISO(); }

    function generate(){
      const rand = seededRand(currentSeed());
      const gens = [genGCF, genDiffSquares, genTrinomialA1, genTrinomialAGt1];
      const set = gens.map(fn => fn(rand));
      shuffle(rand,set);
      renderSet(set);
      const url = new URL(location.href); url.searchParams.set('d', dateEl.value || chicagoISO()); history.replaceState({}, '', url);
    }

    function renderSet(set){
      problemsEl.innerHTML = set.map((p,i)=>{
        const [c0,c1,c2] = p.coeffs; // [constant, x, x^2]
        const html = polyToHTML(c2,c1,c0);
        return `
          <article class="card" data-idx="${i}">
            <h3>Problem ${i+1}</h3>
            <div class="problem">Factor: <strong>${html}</strong></div>
            <div class="row" style="margin-top:8px">
              <label class="meta">Your answer (use parentheses, e.g., (x+3)(2x-5))</label>
              <input class="answer" id="ans-${i}" type="text" placeholder="e.g., (x+3)(x+4) or -1(x-2)(x-3)" />
            </div>
            <div class="meta" id="msg-${i}" style="min-height:22px; margin-top:6px"></div>
            <details>
              <summary>Show a sample solution</summary>
              <div class="meta" style="margin-top:6px">One factored form: <strong>${p.sample}</strong></div>
            </details>
          </article>`;
      }).join('');
      window.__currentSet = set;
      scoreEl.textContent = '';
      btnSubmit.disabled = true;
    }

    function multiplyMonomials(mon, f){ return polyMul(mon,f); }
    function isMonomial(poly){ return (poly[0]!==0) + (poly[1]!==0) + (poly[2]!==0) === 1; }
    function monomialCoefPow(poly){ if(poly[2]!==0) return {coef:poly[2], pow:2}; if(poly[1]!==0) return {coef:poly[1], pow:1}; return {coef:poly[0], pow:0}; }

    function checkAnswers(){
      if(!window.__currentSet) return;
      const set = window.__currentSet;
      let correct=0;
      for(let i=0;i<set.length;i++){
        const target = set[i].coeffs; // [c0,c1,c2]
        const gCoef = set[i].gCoef, gPow = set[i].gPow;
        const inp = document.getElementById(`ans-${i}`).value.trim();
        const msg = document.getElementById(`msg-${i}`);
        if(!inp){ msg.innerHTML = '<span class="warn">Enter an answer.</span>'; continue; }
        const parsed = expandExpression(inp);
        if(!parsed){ msg.innerHTML = '<span class="err">Could not parse. Use forms like (x+3)(2x-1) with parentheses.</span>'; continue; }
        if(!polyEqual(parsed.poly, [target[0],target[1],target[2]])){
          msg.innerHTML = '<span class="err">Does not expand to the original polynomial.</span>'; continue;
        }
        if(parsed.factorPolys.length < 2){ msg.innerHTML = '<span class="warn">Not factored. Provide it as a product of factors.</span>'; continue; }
        let mon=[1,0,0];
        for(const f of parsed.factorPolys){ if(isMonomial(f)) mon = multiplyMonomials(mon,f); }
        const {coef:monC,pow:monP} = monomialCoefPow(mon);
        const monAbs = Math.abs(monC);
        if(gCoef>1 || gPow>0){
          if(!(monAbs===gCoef && monP===gPow)){
            msg.innerHTML = `<span class="err">Factor out the GCF first: expected <strong>${gCoef}${gPow>0?`x${gPow===1?'':`^${gPow}`}`:''}</strong> as an outside monomial factor.</span>`;
            continue;
          }
        }
        msg.innerHTML = '<span class="ok">Correct ✔</span>';
        correct++;
      }
      scoreEl.textContent = `Score: ${correct}/${set.length}`;
      btnSubmit.disabled = false;
      return correct;
    }

    async function sha256Hex(str){ const buf=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256',buf); const arr=Array.from(new Uint8Array(hash)); return arr.map(b=>b.toString(16).padStart(2,'0')).join(''); }

    async function submitResults(){
      if(!SCRIPT_URL){ alert('Submission endpoint not set.'); return; }
      const set = window.__currentSet; if(!set) return;
      const date = dateEl.value || chicagoISO();
      let sid = sidEl.value.trim(); if(!sid){ alert('Enter student number.'); return; }
      const idToSend = hashIdEl.checked ? await sha256Hex(sid) : sid;
      const answers = [];
      for(let i=0;i<set.length;i++){
        const raw = document.getElementById(`ans-${i}`).value.trim();
        const parsed = expandExpression(raw);
        const ok = !!parsed && polyEqual(parsed.poly, [set[i].coeffs[0], set[i].coeffs[1], set[i].coeffs[2]]) && parsed.factorPolys.length>=2;
        let mon=[1,0,0]; if(parsed){ for(const f of parsed.factorPolys){ if(isMonomial(f)) mon= multiplyMonomials(mon,f); } }
        const {coef:monC,pow:monP} = monomialCoefPow(mon);
        const pulledGCF = (Math.abs(monC)===set[i].gCoef && monP===set[i].gPow);
        answers.push({ raw, correct: ok && (set[i].gCoef<=1 && set[i].gPow===0 ? true : pulledGCF), pulledGCF });
      }
      const payload = { date, studentId:idToSend, hashed:hashIdEl.checked, score: answers.filter(a=>a.correct).length, total: answers.length, answers, problems: set.map(p=>({ coeffs:p.coeffs, gCoef:p.gCoef, gPow:p.gPow })) };
      try{ const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); if(!res.ok) throw new Error('HTTP '+res.status); scoreEl.textContent = 'Submitted!'; }catch(e){ alert('Submit failed: '+e.message); }
    }

    // ======= Init =======
    readParams();
    generate();
    btnRegen.addEventListener('click', generate);
    btnReveal.addEventListener('click', ()=>{ document.querySelectorAll('#problems details').forEach(d=>d.open=true); });
    btnCheck.addEventListener('click', checkAnswers);
    btnSubmit.addEventListener('click', submitResults);
    document.getElementById('printBtn').addEventListener('click', ()=>window.print());
  </script>
</body>
</html>
